<html>
<head>
    <title>HAB's Location</title>
    <!--<meta http-equiv="refresh" content="30" />-->
    <meta charset="utf-8" />
    <!-- <meta name="viewport" content="width=device-width, initial-scale=1.0">-->
    <link rel="stylesheet" href="leaflet/leaflet.css" />
    <script type="text/javascript" src="leaflet/leaflet.js"></script>
    <script type="text/javascript" src="leafletembed.js"></script>
    <!--<script type="text/javascript" src="leaflet-omnivore/leaflet-omnivore.min.js"></script>-->
    <script src='//api.tiles.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.3.1/leaflet-omnivore.min.js'></script>
    <script type="text/javascript" src="Chart.js/Chart.js"></script>
    <!--<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.6.0/chart.min.js"></script>-->
    <script type="text/javascript" src="Chart.Scatter/Chart.Scatter.js"></script>
    <script
              src="https://code.jquery.com/jquery-3.3.1.min.js"
              integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
              crossorigin="anonymous"></script>

</head>
<body>
    <h2><span id="distintivo"></span>'s status as of <span id="tiempo"></span>:</h2>
    <h4>Battery: (<span class="voltios"></span> V)</h4>
    <h4>Data: (<span class="datos"></span>)</h4>
    <h4>Globo: (<a class="globo"></a>)</h4>
    <h4>Meta: (<a class="meta"></a>)</h4>
    <input type="button" onclick="recarga()" value="Recarga" ></input>
    <input type="button" onclick="simula(globo_position)" value="Simula online" ></input>
    <input type="button" onclick="simula_caida(globo_position)" value="Simula caida" ></input>
    <!--<input type="button" onclick="simula_inicial([42.0408,-0.5762])" value="Simula Almudevar" ></input>-->
    <input type="button" onclick="llevame(globo_position)" value="Llevame globo" ></input>
    <input id="button_llevame_meta" disabled="true" type="button" onclick="llevame(finish_position)" value="Llevame meta" ></input>
    <br/>
    <canvas id="batteryChart" width="200" height="200"></canvas>
    <canvas id="historyChart" height="200"></canvas>
    <!-- <iframe width="<?=$width?>" height="<?=$height?>" frameborder="0" scrolling="no" marginheight="0" marginwidth="0" src="<?=$embedUrl?>" style="border: 1px solid black"></iframe> -->
    <div id="map" style=" height: 600px"></div>
    <small><!--<a href="">View Larger Map</a>--></small>
        <script>
            var my_position;
            var globo_position;
            var finish_position;
            var track;
            var asc_poly, des_poly;
            var globo_marker, my_marker, finish_marker;
            recarga();
            //simula();
            simula_inicial([42.0408,-0.5762]);
            initmap();
             //map.setView(new L.LatLng(40, 0),17); 
            //omnivore.gpx('s2g.php?file=tmplocation.log').addTo(map);

            // Charts.js
            var batteryCtx = document.getElementById("batteryChart").getContext("2d");
            var data = [
                {
                    value: "0",
                    color: "rgba(0,0,220,0.8)",
                    highlight: "rgba(0,0,220,1)",
                    label: "Charge",
                },
                {
                    value: 0,
                    color: "rgba(0,0,0,0)",
                    highlight: "rgba(0,0,0,0)",
                    label: "Empty",
                }
            ]
            var batteryChart = new Chart(batteryCtx).Pie(data, {showScale: true});
            
            var historyCtx = document.getElementById("historyChart").getContext("2d");
            var historyData = [{
                label: 'Simulacion Inicial',
                strokeColor: '#F16220',
                pointColor: '#F16220',
                pointStrokeColor: '#fff',
                data: [
                                ]
            },
            ];
            options = {
                pointDot: false,
                bezierCurve: false,
                scaleType: "date",
                useUtc: false,
                animation: false,
            }
            //var historyChart = new Chart(historyCtx).Scatter(historyData,options);
        function recarga() {
            //$.getJSON( 'https://api.aprs.fi/api/get?name=EA2DVJ-11&what=loc&apikey=109984.vUFksEiAq8PAsJQ&format=json', function ( data ) { alert(data);}   );
            $.ajax({
                //url: "https://api.aprs.fi/api/get?name=EA2DVJ-11&what=loc&apikey=109984.vUFksEiAq8PAsJQ&format=json",
                url: "aprs.php",
                //data: {name: "EA2DVJ-11", what: "loc", apikey: "109984.vUFksEiAq8PAsJQ",format: "json"},
                type: "GET",
                dataType: "json",
                beforeSend: function(request) {
                    request.setRequestHeader("User-Agent","HAB-tracker/0.0.1 (https://github.com/alejandroscf/hab-tracker)");
                },
                success: function (foo) {
                   $("#distintivo").text("EA2DVJ-11");
                   console.log(foo);
                   $fecha = new Date();
                   $fecha.setTime(foo.entries[0].lasttime*1000);
                   //console.log(foo.entries[0].lasttime);
                   //console.log(foo.entries[0].time);
                   //console.log($fecha);
                   $("#tiempo").text($fecha);
                   $(".datos").text(foo.entries[0].comment.replace(/,/g,', '));
                   url = "https://osmand.net/go?lat="+foo.entries[0].lat+"&lon="+foo.entries[0].lng;
                   $(".globo").text(url);
                   $(".globo").attr("href",url);
                   $lat = foo.entries[0].lat;
                   $lng = foo.entries[0].lng;
                   globo_position = [foo.entries[0].lat, foo.entries[0].lng, foo.entries[0].altitude]
                   var globoIcon = new L.Icon({iconUrl: 'globo.png'});
                   globo_marker = L.marker([$lat, $lng], {icon: globoIcon}).addTo(map);
                   map.setView(new L.LatLng($lat, $lng));

                   //encuentrame();
                   navigator.geolocation.getCurrentPosition(
                      function (pos) {
                         my_position = [pos.coords.latitude, pos.coords.longitude];
                         //console.log(pos);
                         var coor = "" + pos.coords.latitude + "," + pos.coords.longitude + ";" + $lat + "," + $lng ;
                         var coortxt = "" + pos.coords.latitude + "," + pos.coords.longitude + "|" + $lat + "," + $lng ;
                         my_marker = L.marker([pos.coords.latitude, pos.coords.longitude]).addTo(map);
                         //map.setView(new L.LatLng(pos.coords.latitude, pos.coords.longitude));
                         //console.log(coor);
                      }
                   );
               },
            });
        };
        function llevame (dest) {
          try { map.removeLayer(track); } catch (error) {};
          var point1 = "" + my_position[0] + "," + my_position[1];
          var point2 = "" + dest[0] + "," + dest[1] ;
          $.ajax({
             //osrm (osm)
             //url: "https://router.project-osrm.org/route/v1/driving/" + coor,
             //data: {overview: "false", geometries: "polyline", steps: "true"},
             //osrm (api)
             //url: "https://api.openrouteservice.org/directions",
             //data: { coordinates: coortxt, profile: "driving-car", geometry: "true", geometry_format: "polyline",},
             //profile: "foot-hiking"
             url: "https://graphhopper.com/api/1/route?point="+ point1,
             data: {point: point2, type: "gpx", key: "a54c1ef8-63cb-42c5-817d-326e8aa31587"},
             type: "GET",
             success: function (gpx_track) {
                console.log(gpx_track);
                track = omnivore.gpx.parse(gpx_track).addTo(map);
                //map.fitBounds(track.getBounds());
             },
          });
        }

   function wrapLng(lng) {
      if (lng < 0) { lng = parseFloat(lng) + 360 };
      return lng;
   }
   function unWrapLng(lng) {
      if (lng > 180) { lng = lng - 360 };
      return lng;
   }
	function simula_inicial(position) {
      //try { map.removeLayer(asc_poly);map.removeLayer(des_poly);map.removeLayer(finish_marker); } catch (error) {};
      console.log(wrapLng(position[1]));
      $fecha_sim = "2021-11-06T11:00:00.000Z";
      $.getJSON( 
         "https://predict.cusf.co.uk/api/v1/?launch_latitude="+position[0]+"&launch_longitude="+wrapLng(position[1])+"&launch_datetime="+$fecha_sim+"&ascent_rate=5.38&descent_rate=3.5&burst_altitude=35000", 
         function ( data ) { 
            console.log(data);
            var asc_points_init = data.prediction[0].trajectory.map(function(x) {
               return [x.latitude,unWrapLng(x.longitude)];
            });
            asc_poly_init = L.polyline(asc_points_init, {color: 'grey'}).addTo(map);
            //map.fitBounds(asc_poly.getBounds());
            //console.log(asc_poly);
            var des_points_init = data.prediction[1].trajectory.map(function(x) {
               return [x.latitude,unWrapLng(x.longitude)];
            });
            des_poly_init = L.polyline(des_points_init, {color: 'grey'}).addTo(map);
            map.fitBounds(des_poly_init.getBounds().extend(asc_poly_init.getBounds()));
            //map.setView(new L.LatLng(41.6633,-0.8250),12);
            //console.log(des_poly);
            //console.log(des_points[des_points.length - 1]);
            finish_position = des_points_init[des_points_init.length - 1];
            //finish_marker = L.marker(finish_position).addTo(map);
            //console.log(globo_position);
            $("#button_llevame_meta").prop('disabled', false);
            var alti_hist = data.prediction[0].trajectory.concat(data.prediction[1].trajectory).map(function(item) {
               return { x: new Date(item.datetime).getTime() , y: item.altitude }
            });
            //console.log(alti_hist);
            historyData[0].data = alti_hist; 
            //console.log(historyData);
            historyChart = new Chart(historyCtx).Scatter(historyData,options);
            //historyChart2 = historyChart .Scatter(historyData,options);
            url = "https://osmand.net/go?lat="+finish_position[0]+"&lon="+finish_position[1];
            $(".meta").text(url);
            $(".meta").attr("href",url);
         }
      );

   }
	function simula(position) {
      try { map.removeLayer(asc_poly);map.removeLayer(des_poly);map.removeLayer(finish_marker); } catch (error) {};
      $fecha_sim = new Date().toISOString();
      //console.log(position[1]);
      //console.log(wrapLng(position[1]));
      $.getJSON( 
         "https://predict.cusf.co.uk/api/v1/?launch_latitude="+position[0]+"&launch_longitude="+wrapLng(position[1])+"&launch_datetime="+$fecha_sim+"&ascent_rate=5.38&descent_rate=3.5&burst_altitude=35000&launch_altitude="+position[2], 
         function ( data ) { 
            //console.log(data);
            var asc_points = data.prediction[0].trajectory.map(function(x) {
               return [x.latitude,unWrapLng(x.longitude)];
            });
            asc_poly = L.polyline(asc_points, {color: 'green'}).addTo(map);
            //map.fitBounds(asc_poly.getBounds());
            //console.log(asc_poly);
            var des_points = data.prediction[1].trajectory.map(function(x) {
               return [x.latitude,unWrapLng(x.longitude)];
            });
            //console.log(des_points);
            des_poly = L.polyline(des_points, {color: 'red'}).addTo(map);
            map.fitBounds(des_poly.getBounds().extend(asc_poly.getBounds()));
            //map.setView(new L.LatLng(41.6633,-0.8250),12);
            //console.log(des_poly);
            //console.log(des_points[des_points.length - 1]);
            finish_position = des_points[des_points.length - 1];
            finish_marker = L.marker(finish_position).addTo(map);
            //console.log(globo_position);
            url = "https://osmand.net/go?lat="+finish_position[0]+"&lon="+finish_position[1];
            $(".meta").text(url);
            $(".meta").attr("href",url);
            $("#button_llevame_meta").prop('disabled', false);
         }
      );
	};
	function simula_caida(position) {
      try { map.removeLayer(asc_poly);map.removeLayer(des_poly);map.removeLayer(finish_marker); } catch (error) {};
      $fecha_sim = new Date().toISOString();
      console.log(position);
      //console.log(wrapLng(position[1]));
      $.getJSON( 
         "https://predict.cusf.co.uk/api/v1/?launch_latitude="+position[0]+"&launch_longitude="+wrapLng(position[1])+"&launch_datetime="+$fecha_sim+"&ascent_rate=5.38&descent_rate=3.5&burst_altitude="+(parseInt(position[2])+1)+"&launch_altitude="+position[2], 
         function ( data ) { 
            //console.log(data);
            //map.fitBounds(asc_poly.getBounds());
            //console.log(asc_poly);
            var des_points = data.prediction[1].trajectory.map(function(x) {
               return [x.latitude,unWrapLng(x.longitude)];
            });
            //console.log(des_points);
            des_poly = L.polyline(des_points, {color: 'red'}).addTo(map);
            map.fitBounds(des_poly.getBounds());
            //map.setView(new L.LatLng(41.6633,-0.8250),12);
            //console.log(des_poly);
            //console.log(des_points[des_points.length - 1]);
            finish_position = des_points[des_points.length - 1];
            finish_marker = L.marker(finish_position).addTo(map);
            //console.log(globo_position);
            url = "https://osmand.net/go?lat="+finish_position[0]+"&lon="+finish_position[1];
            $(".meta").text(url);
            $(".meta").attr("href",url);
            $("#button_llevame_meta").prop('disabled', false);
         }
      );
	};




        </script>

</body>
</html>
